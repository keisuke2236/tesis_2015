
%------------------------------------------------------%
%- 構成
%- プログラムが実際どういう関連性があるのかについて少し細かく説明する
%------------------------------------------------------%
知能ハブの構成を3段階に分けてと，Unityのキャラクターとの連携，
解析や出力をするアルゴリズムを選定する時に利用しているGoogkeAPIの流れで，
人工知能利用フレームワークの構成を解説します．
\\
最初に人工知能ハブの全体的な解析から出力の流れを示す図を以下の　　に提示します
%------------------------------------------------------%
\section{入力された情報を解析する機構}
まず初めにUnity上のキャラクターへユーザが発言し，知能ハブが受け取った情報を解析する際の機構に
ついて解説したいと思います．\\

以下\figref{analyze_chart}に入力された情報が解析され，解析結果がデータベースに格納されるまでの
構成を示す．

\figPst{100}{analyze_chart}{解析が行われるまでの図}
\figref{analyze_chart}の大まかな流れを説明すると，初めにユーザーがUnity上で動作している
キャラクターに話しかけると，その内容をUnityが聞き取り，知能ハブへと送信します．
送信した情報は知能ハブで受け取られ，その入力された情報は，
それぞれ解析したい情報ごとに作られているハブへと渡されます．\\
\figref{analyze_chart}の場合，感情を解析する感情解析知能ハブと話題を解析する話題解析知能
ハブがあるため，入力された情報はこの2つの解析ハブへと送信されます．\\

情報が送信されると各解析ハブは入力された情報をもとに，登録されている各解析アルゴリズムの中から
もっとも適切な解析アルゴリズムを選択し，実際の解析を行わせます．\\

実際に解析された情報は知能ハブ全体で共有されているデータベースへ保存することで，様々な場所から
利用することができるようになります．\\

それでは以下の章で解析知能ハブの中のそれぞれの機能について説明したいと思います．


\subsection{解析する情報別にアルゴリズムを保持する機能}
\figref{analyze_chart}を見て分かる通り，入力された情報は各解析する情報ごとに入力データを
渡していきます．\\
そして，各解析知能は入力された情報からその物事を解析するためのアルゴリズムを複数持っており，
それを具体例を用いて表した図を以下の\figref{feel_analyze}に示します．

\figPst{100}{feel_analyze}{感情解析知能ハブとそれに付随する解析アルゴリズム}

具体的に説明をすると，\figref{feel_analyze}の感情解析知能ハブは，感情を解析するための
複数のアルゴリズムを持っていることになります．\\

各，感情解析知能ハブや話題解析知能ハブなどはアルゴリズム型の配列を持っており，
その配列内に解析アルゴリズムの抽象クラスを実装したものを格納するだけで複数のアルゴリズムを保持し，
適切なアルゴリズムが選択されるように設計されています．\\

また，解析する情報である感情や，話題といった種類はその他にも抽象クラスを実装し，
解析知能ハブに登録することで追加することができます．\\


\subsection{会話の話題別に解析するアルゴリズムを選ぶ機能}
この人工知能ハブでは現在話している話題をもとに，どの解析アルゴリズムを選択するかを判定しています．\\
なので料理に関する話題をしているときは，料理関連の単語や会話に対応した解析アルゴリズムがあれば
それが解析を行い，ない場合はその他の解析アルゴリズムの中でもっとも適した解析アルゴリズムが
解析を行う設計になっています．\\
この話題を推定する際にはgoogle検索のAPIを用いており，入力された内容を検索にかけてその結果から
話題を推定しています．\\
こうすることで例えば，以下の\figref{kuppa_down}「クッパ
	\footnote{クッパ：ゲーム「スーパーマリオブラザーズ」に登場する敵キャラクター}
が落ちた」という入力があったときに「クッパ　落ちた」で検索をした結果を取得します．

\figPst{100}{kuppa_down}{2015年12月20日現在の「クッパ　落ちた」のGoogle検索結果}

\figref{kuppa_down}の上位5件の検索結果を見るとゲームの話題であると判定され，ゲームに特化した
感情解析を行うアルゴリズムが選択されます．\\

また，この時に「クッパ
	\footnote{クッパ：クッパは韓国料理の一種。 スープとご飯を組み合わせた雑炊のような料理}
って美味しいよね」という入力があった場合，以下の\figref{kuppa_umai}の「クッパ　美味しい」
の検索上位5件を見て分かる通り，韓国料理のクッパの話題となるため料理に特化した感情解析を行う
アルゴリズムが選択されます．
\figPst{100}{kuppa_umai}{2015年12月20日現在の「クッパ　美味しい」のGoogle検索結果}

このようにその時々に合わせて，適切な解析を行うアルゴリズムが選択されるような構造があり，これによ
って，より高精度な解析を行うことができます．\\

もし，このような機能がない場合，「クッパが落ちた」という文章は「落ちた」というキーワードから
，たとえクッパという単語が料理名だと判明しても，ゲームの敵キャラクターとわからない限りは
マイナスイメージな文と解析されると推測できます．\\

また，この両方を適切に解析できる，つまり現在の話題に限らず，感情を解析できるアルゴリズムを作成
した場合は，そのアルゴリズムのみを感情解析知能ハブに登録することで確実にそのアルゴリズムが解析
を行うように設定することが可能です．

\subsection{解析アルゴリズムを簡単に追加する機能}
実際に解析を行うアルゴリズム自体を簡単に追加する機能について解説します．\\
この，実際に解析を行うアルゴリズムの実装はあらかじめ定義されている抽象クラスを実装することで
完了し，その実装の手順もソースコードの行数に換算すると最短3行でアルゴリズムを追加することが可能
です．\\

\figref{feel_analyze}のゲームプレイ時における感情解析知能を追加したい場合は，抽象クラスを
実装後，感情解析知能ハブにある抽象クラス型を保持する配列に対して，
作成した抽象クラスを拡張したプログラムを入れることで実装を行うことができます．

話題を解析する知能ハブが親の抽象クラスを実装したもので，それに付随する解析アルゴリズムは子の抽象
クラスを実装したものという構図になり，その関係性を以下の\figref{analyze_abs}に示します．

\figPst{100}{analyze_abs}{抽象クラスの関係と抽象クラスの実装例}

\figref{analyze_abs}の通り，親の抽象クラスだけでなく，子の抽象クラスに関しても簡単に実装を
行い，追加する機構がある．

%------------------------------------------------------%
\newpage
%------------------------------------------------------%

\section{解析結果を保存する機構}
この人工知能ハブには解析を行った情報やその他の様々な情報を保存するためのデータベースクラスが実装
されている．\\

そして，このデータベースクラスはすべてのクラスで共有で利用できるように，すべての解析知能や出力
を作成する知能の抽象クラスに含まれている．\\

\subsection{解析情報を保存する機能}
このデータベースは，解析した情報を保存する機能がある．\\
しかし，情報を保存するにあたり，解析を行うアルゴリズムを作る人によって解析結果の形式が異なる
ことが予想できるため，どのようなオブジェクトでも保存が可能なようにobject型を利用している．\\

実際に保存を行う場合は各解析アルゴリズム内でデータベースオブジェクトのメソッドに対して保存したい
内容を引数で渡すだけで保存を行うことができる．\\

保存する際に付けられる名前は明確性と同一名のデータが存在しないように，その解析アルゴリズムの
プログラム名＋データの形式という形で保存する．\\

例えばMode-Topic-Gameというゲーム話題解析知能が文字列で話題を保存したい場合はそのアルゴリズム
の中で，解析が終わった時にデータベースオブジェクトの保存を行うメソッドに対して値を渡す．\\

そして，その保存した情報に対してMode-Topic-Game-Stringという名前をつけることで明確性と
同一名のデータが存在しないようにしている．\\

\subsection{解析情報を取得する機能}
その次に解析した情報を出力内容を作成するアルゴリズムの中から呼び出す方法について解説します．\\
実際に解析を行う際にはデータベースオブジェクトの情報取得メソッドに対して先ほどの解析情報の保存
で説明した，欲しい情報の名前を指定することでその情報を取得することができる．\\

%------------------------------------------------------%
\newpage
%------------------------------------------------------%


\section{解析情報を元に出力内容を作成する機構}
解析された情報を元にUnityのヤラクターに送信する出力内容を作成する工程についてユーザーがUnity上
のキャラクターとの会話をする例を表した\figref{output}を用いて説明します．

\figPst{100}{output}{出力情報を作成するまでの流れ}

\figref{output}を見て分かる通り出力作成知能ハブにも出力したい情報ごとにアルゴリズムを保持する
機構があり，今回の\figref{output}の場合は会話を行うための会話知能ハブとキャラクターの動作を
選択するための動作選択知能ハブの2つがある．\\

それぞのハブでは入力された情報を元に，解析知能ハブの時と同じように最適なアルゴリズムを選択します，
選択されたアルゴリズムはそれぞれデータベースにある，利用したい情報を取得し，返答内容や動作を決定
します．\\

それぞれのアルゴリズム処理結果はUnityへの命令形式であるJSON形式にまとめられ，
websocket通信でUnityへと送信され，Unityが命令を解釈，キャラクターが動作するという流れになります．


\subsection{返答を行うタイミング}
人工知能ハブが返答を行うことができるタイミングは2種類あります．\\
1つめは相手から入力があった場合の返答，2つ目が自ら発言する場合に返答する場合です．\\
\\
相手から入力があった場合の返答はUnityから情報が送信されてきた時に出力を作成する知能ハブを呼び出
すことで出力内容を作成し，返答を行っています．\\

自ら発言を行う場合は実装を行ってあるタイマーを利用して発言を行います．
特定の時間や変数の値になった時に発言を行うように設定することが可能であり，出力内容作成知能ハブの
自発的に発言する出力内容を作成するメソッドをそのタイミングで呼び出すことが可能になっています．\\
\\
感情値や時間経過，状況の変化のあった時にwebsocketを用いて通信をUnityへ送信できるため，
自発的に発言しているように見せることが可能です．\\

また，自ら発言する場合と，返答を行う場合でアルゴリズムが異なることが多いため，\figref{analyze_abs}
のアルゴリズムを実装するための子の抽象クラスには返答する際のアルゴリズムと自ら発言する際の
アルゴリズムを書くメソッドが用意されています．\\

\subsection{会話の話題別に返答アルゴリズムを保持する機能}
返答を行う際も，解析を行うときと同様に話題別に返答アルゴリズムを保持しています．\\

また，返答アルゴリズムを保持する仕組みに関しても同じく，返答アルゴリズム型の配列を持っており，
その配列内に返答アルゴリズムの抽象クラスを実装したものを格納するだけで複数のアルゴリズムを保持し，
適切なアルゴリズムが選択される部分についても同じ仕組みで動いています．\\

\subsection{会話の話題別に返答アルゴリズムを選ぶ機能}
出力情報ごとにアルゴリズムを保持しているため，解析知能ハブの時と同じように，その時々
に合わせて最適なアルゴリズムが解析を行うようになっています．


%------------------------------------------------------%
\newpage
%------------------------------------------------------%


\section{作成した知能をUnityで試す機構}
作成したアルゴリズムをすぐに実行し，試す環境として今回は統合開発環境を内蔵し、
複数のプラットホームに対応するゲームエンジンであるUnityを採用しました．\\

このゲームエンジンを用いることでウェブブラウザ上で動作するキャラクターを簡単に作成することが
でき，ブラウザ上で動作するため，様々なプラットフォームで試すことができます．\\

また，ブラウザを搭載していないデバイスの場合でもUnity自体が複数のプラットフォームに
対応しているため，様々な人が開発したアルゴリズムをすぐに試すことができます．\\

\subsection{UnityWebPlayerでの出力について}
今回作成した人工知能利用フレームワークではUnityWebPlayerを用いてブラウザ上でキャラクターとの
コミュニケーションを取れるように設計しました．\\

\figPst{100}{unity}{Unity Web Playerによるキャラクターの表示画面}

\figref{unity}のようにブラウザを搭載しているPCやmacなどのデバイスならばキャラクターを表示する
ことが出来，作成したアルゴリズムをすぐに試すことが可能です．\\

\subsection{Unityとの連携に利用するWebSocket}
Unityとの通信にはWeb Socketを用いています．\\

web socketとはウェブサーバーとウェブブラウザとの間の通信のために規定を予定している双方向通信用
の技術規格であり，それを採用した理由としてあげられるのが任意のタイミングでのpush通知が可能な点です．\\

push通知が可能になることによって，人工知能利用フレームワークから好きなタイミングで命令を送信し，
Unity上のキャラクターを動作させることができるようになるだけではなく，Unity側のプログラムとしても
命令がきた時にだけキャラクターを動作させ，ユーザーから入力があった時だけサーバへ入力情報を送信
すればよいので処理が軽減されるという利点もあります．\\

\subsection{Unityへの送信フォーマットと作成}
\figref{output}の「返答内容をJSON形式にまとめてpush送信する」という部分の解説を行います．\\
このUnityへの送信は汎用性の高いJSON形式\footnote{JSON形式：軽量なデータ記述言語の1つ}を用い
て送信を行っています．\\

このJSON形式のデータを実際に作成しているのは\figref{output}の出力知能作成ハブであり，
各それぞれの返答内容作成知能ハブや動作選択知能ハブから受け取った情報をまとめてJSON形式
にしています．\\


\subsection{Unityからの受信フォーマット}
Unityから情報を受け取る際にもJSON形式を用いており，
現在はユーザーが発言した内容を取得している．\\


%------------------------------------------------------%
\newpage
%------------------------------------------------------%

\section{アルゴリズムを選定する際に用いるGoogleAPI}
上記で説明したアルゴリズムを選定する際に用いているGoogleAPIについて解説します．\\

\subsection{GoogleAPIについて}
このGooogleAPIは独自に開発したプログラムであり，
HttpClientを用いてウェブ上からGoogleの検索結果を取得し，その結果をHttpCleanerで整形している．\\
その後整形した情報を形態素解析にかけて，固有名詞のみを抽出し，固有名詞の単語票を作っています．\\
\\

\subsection{GoogleAPIの有効性}
Googleの検索結果を用いることで，常に最新の検索ワードに関するキーワードが手に入ります．
\\
そのほかにも一見「料理」という単語と「ごはん」という単語には関連性がないように見える単語も，
この2つの検索結果の単語票を比較することで同じ分野の単語であることを知ることができます．\\