
%------------------------------------------------------%
%- 構成
%- プログラムが実際どういう関連性があるのかについて少し細かく説明する
%------------------------------------------------------%
知能ハブの構成を3段階に分けてと，Unityのキャラクターとの連携，
解析や出力をするアルゴリズムを選定する時に利用しているGooglzeAPIの流れで，
人工知能利用フレームワークの構成を解説する．
\\
また，全体の構成は\ref{sec:allAr}に示した図と同じ構成となっている．
%------------------------------------------------------%
\section{入力された情報を解析する機構}
まず初めにUnity上のキャラクターへユーザが発言し，知能ハブが受け取った情報を解析する際の機構に
ついて解説します．\\

以下\figref{analyze_chart}に入力された情報が解析され，解析結果がデータベースに格納されるまでの
構成を示す．

\figPst{100}{analyze_chart}{解析が行われるまでの図}
\figref{analyze_chart}の大まかな流れを説明すると，初めにユーザーがウェブブラウザ上で動作している
Unityを用いて開発されたキャラクターに話しかけると，
その内容をUnityが受け取り文字列に変換して，人工知能ハブへと送信する．
\\
送信した情報は人工知能ハブで受け取られ，その入力された情報は，それぞれ解析したい情報ごとに作られている
各解析知能ハブへと渡される．
\\
\figref{analyze_chart}の場合，感情を解析する「感情解析知能ハブ」と話題を解析する「話題解析知能
ハブ」があるため，入力された情報はこの2つの解析ハブへと送信される．
\\
情報が送信されると各解析ハブは入力された情報をもとに，登録されている各解析アルゴリズムの中から
もっとも適切な解析アルゴリズムを選択し，実際の解析を行う．
\\
実際に解析された情報は知能ハブ全体で共有されているデータベースへ保存される設計となっており，
また，その情報は様々な解析クラスや出力を作成するクラスから利用することが可能である．
\\
それでは以下の章で解析知能ハブの中のそれぞれの機能について説明する．


\subsection{解析する情報別にアルゴリズムを保持する機能}
\figref{analyze_chart}を見て分かる通り，入力された情報は各解析する情報ごとに入力データを
渡す．
\\
そして，各解析知能は入力された情報からその情報を解析するためのアルゴリズムを複数所持しており，
それを具体例を用いて表した図を以下の\figref{feel_analyze}に示す．

\figPst{100}{feel_analyze}{感情解析知能ハブとそれに付随する解析アルゴリズム}

\figref{feel_analyze}の感情解析知能ハブは，複数の話題毎に特化した
感情を解析するためのアルゴリズムを所持している．
\\
各感情解析知能ハブや話題解析知能ハブなどはアルゴリズム型の配列を持っており，
\figref{feel_analyze}の「料理時に置ける感情解析知能」や「ゲームプレイ時における感情解析知能」
などはその配列に含まれている．\\
このように，配列内に解析アルゴリズムの抽象クラスを実装したものを格納するだけで，複数のアルゴリズムを所持し，
適切なアルゴリズムが選択されるように設計されている．
\\
また，\figref{feel_analyze}の「感情解析知能ハブ」にあたる解析する情報である感情や，話題といった種類
はその他にも，このクラスが継承している「親抽象クラス\footnote{独自実装を行った解析する感情や話題
といった種類を増やす時に用いる抽象クラス}」を実装し，解析知能ハブにある抽象クラスを
保存している配列に追加することでそのアルゴリズムを増やすことができる．
\\

\subsection{会話の話題別に解析するアルゴリズムを選ぶ機能}
この人工知能ハブでは現在話している話題をもとに，どの解析アルゴリズムを選択するかを判定している．\\
よって，料理に関する話題をしている際は，料理関連の単語や会話に対応した解析アルゴリズムがが選択され
解析を行い，料理関連のアルゴリズムがない場合はその他の解析アルゴリズム
の中でもっとも適した解析アルゴリズムが解析を行う設計になっている．
\\
話題を推定する際にはGoogleAPI\footnote{独自実装を行ったGoogleを用いて検索を行う機能}
を用いており，入力された内容を検索にかけて，頻出単語表を作成し，既存の各アルゴリズムと最も
頻出単語表が似ている話題をもつ解析アルゴリズムが解析を行います．
\\
この様な構造を用いることで，以下の\figref{kuppa_down}「クッパ
	\footnote{クッパ：ゲーム「スーパーマリオブラザーズ」に登場する敵キャラクター}
が落ちた」という入力があったときに「クッパ　落ちた」で検索をした結果を取得します．

\figPst{100}{kuppa_down}{2015年12月20日現在の「クッパ　落ちた」のGoogle検索結果}

\figref{kuppa_down}の検索結果の場合，検索結果を見るとゲームの話題であると判定され
ゲームに特化した感情解析を行うアルゴリズムが選択される．\\

このアルゴリズムが実装されている時に同時に料理のアルゴリズムが実装されているとする，すると「クッパ
	\footnote{クッパ：クッパは韓国料理の一種。 スープとご飯を組み合わせた雑炊のような料理}
って美味しいよね」という入力があった場合，以下の\figref{kuppa_umai}の「クッパ　美味しい」
の検索結果を見て分かる通り，韓国料理のクッパの話題となるため料理に特化した感情解析を行う
アルゴリズムが選択されるように設計している．

\figPst{100}{kuppa_umai}{2015年12月20日現在の「クッパ　美味しい」のGoogle検索結果}

このようにその時々に合わせて，適切な解析を行うアルゴリズムが選択されるような構造があり，これによ
って，より高精度な解析を行うことができる．
\\
この機能がない場合，「クッパが落ちた」という文章は「落ちた」というキーワードから
，たとえクッパという単語が料理名だと判明しても，ゲームの敵キャラクターとわからない限りは
マイナスイメージな文と解析されると推測されてしまうことが予測できる．
\\
またこの両方の文章を適切に解析できる，つまり現在の話題に限らず，感情を解析できるアルゴリズムを作成
した場合は，そのアルゴリズムのみを感情解析知能ハブに登録することで確実にそのアルゴリズムが解析
を行うように設定することが可能である．
\newpage


\subsection{解析アルゴリズムを簡単に追加する機能}
実際に解析を行うアルゴリズム自体を簡単に追加する機能について解説する．
\\
この，実際に解析を行うアルゴリズムの追加は，予め定義されている子の抽象クラスを実装することで
追加することが可能であり，その実装の手順もソースコードの行数に換算すると，そのアルゴリズムの話題の設定，
そのアルゴリズム，親クラスへの登録という最短3行でアルゴリズムを追加することが可能になっている．\\

\figref{feel_analyze}のゲームプレイ時における感情解析知能を追加したい場合は，抽象クラスを
実装後，感情解析知能ハブにある抽象クラス型を保持する配列に対して，
作成した抽象クラスを拡張したプログラムを入れることで実装を行うことができる．
\\
話題を解析する知能ハブが親の抽象クラスを実装したもので，それに付随する解析アルゴリズムは子の抽象
クラスを実装したものという構図になり，その関係性を\figref{analyze_abs}に示す．

\figPst{80}{analyze_abs}{抽象クラスの関係と抽象クラスの実装例}

\figref{analyze_abs}の通り，親の抽象クラスだけでなく，子の抽象クラスに関しても新たなアルゴリズムを考案した
際には子の抽象クラスを実装することによって簡単にそのアルゴリズムの実装を行い，感情を解析する
知能ハブや話題を解析する知能ハブに対して特定の話題を持ったアルゴリズムを追加する機構がある．

%------------------------------------------------------%
\newpage
%------------------------------------------------------%

\section{解析結果を保存する機構}
この人工知能ハブには解析を行った情報やその他の様々な情報を保存するためのデータベースクラスが実装
されている．
\\
データベースクラスはすべてのクラスで共有で利用できるように，すべての解析知能や出力
を作成する知能の抽象クラスに含まれている．
\\

\subsection{解析情報を保存する機能}
このデータベースは，解析した情報を保存する機能がある．
\\
しかし，情報を保存するにあたり，解析を行うアルゴリズムを作る人によって解析結果の形式が異なる
ことが予想できるため，どのようなオブジェクトでも保存が可能なようにobject型を利用している．
\\
実際に保存を行う場合は各解析アルゴリズム内でデータベースオブジェクトのメソッドに対して保存したい
内容を引数で渡すだけで保存を行うことができる．
\\
保存する際に付けられる名前は明確性と同一名のデータが存在しないように，その解析アルゴリズムの
プログラム名＋データの形式という形で保存するため，データの衝突が起きない様に設計されている．
\\
例えばMode-Topic-Gameというゲーム話題解析知能が文字列で話題を保存したい場合はそのアルゴリズム
の中で，解析が終わった時にデータベースオブジェクトの保存を行うメソッドに対して値を渡す構造になっている．
\\
そして，その保存した情報に対してMode-Topic-Game-Stringという名前をつけることで明確性と
同一名のデータが存在しないようにしている．
\\
\subsection{解析情報を取得する機能}
その次に解析した情報を出力内容を作成するアルゴリズムの中から取得する方法について解説する．\\
実際に解析を行う際にはデータベースオブジェクトの情報取得メソッドに対して先ほどの解析情報の保存
で説明した，欲しい情報の名前を指定することでその情報を取得することができる．\\
取得する際はobject型で取得されるので，取得する際に利用するキー（文字）の最後を見て
変数の型名にキャストすることで利用出来る．
\\
%------------------------------------------------------%
\newpage
%------------------------------------------------------%

\section{解析情報を元に出力内容を作成する機構}
解析された情報を元にUnityのキャラクターに送信する出力内容を作成する工程についてユーザーがUnity上
のキャラクターとの会話をする例を表した\figref{output}を用いて説明する．

\figPst{100}{output}{出力情報を作成するまでの流れ}

\figref{output}を見て分かる通り出力作成知能ハブにも出力したい情報ごとにアルゴリズムを保持する
機構があり，今回の\figref{output}の場合は会話を行うための会話知能ハブとキャラクターの動作を
選択するための動作選択知能ハブの2つがある．
\\
それぞれのハブでは入力された情報を元に，解析知能ハブの時と同じように最適なアルゴリズムを選択します，
選択されたアルゴリズムはそれぞれデータベースにある，利用したい情報を取得し，返答内容や動作を決定
する．
\\
それぞれのアルゴリズム処理結果はUnityへの命令形式であるJSON形式にまとめられ，
websocket通信でウェブブラウザ上のUnityで開発されたプログラム(以下Unity)へと送信され，Unity
が命令を解釈，キャラクターが動作するという流れになっている．

\subsection{返答を行うタイミング}
人工知能ハブが返答や命令を行うことができるタイミングは2種類ある．
\\
1つめは相手から入力があった場合の返答，2つ目が自ら発言する場合に返答する場合である．
\\
相手から入力があった場合の返答はUnityから情報が送信されてきた時に出力を作成する知能ハブを呼び出
すことで出力内容を作成し，返答を行っている．
\\
自ら発言を行う場合は実装を行ってあるタイマーを利用して発言を行います．
特定の時間や変数の値つまり，特定の感情値になった時に発言を行うように設定することが可能であり，
出力内容作成知能ハブの自発的に発言する出力内容を作成するメソッドをそのタイミングで呼び出すことが
可能となっている．
\\
感情値や時間経過，状況の変化のあった時にwebsocketを用いて通信をUnityへ任意のタイミングでの命令の
送信が可能なため，自発的に発言しているように見せることが可能である．
\\
また，自ら発言する場合と，返答を行う場合でアルゴリズムが異なることが多いため，\figref{analyze_abs}
のアルゴリズムを実装するための子の抽象クラスには返答する際のアルゴリズムと自ら発言する際の
アルゴリズムを書くメソッドが用意されている．
\\
\subsection{会話の話題別に返答アルゴリズムを保持する機能}
返答を行う際も，解析を行うときと同様に話題別に返答アルゴリズムを保持している．
\\
また，返答アルゴリズムを保持する仕組みに関しても同じく，返答アルゴリズム型の配列を持っており，
その配列内に返答アルゴリズムの抽象クラスを実装したものを格納するだけで，複数の返答アルゴリズムを所持し，
適切なアルゴリズムが選択される部分についても同じ仕組みで選択され動作します．\\

\subsection{会話の話題別に返答アルゴリズムを選ぶ機能}
出力情報ごとにアルゴリズムを保持しているため，解析知能ハブの時と同じように，その時々
に合わせて最適なアルゴリズムが解析を行うようになっている．


%------------------------------------------------------%
\newpage
%------------------------------------------------------%


\section{作成した知能をUnityで試す機構}
作成したアルゴリズムをすぐに実行し，試す環境として今回は統合開発環境を内蔵し、
複数のプラットホームに対応するゲームエンジンであるUnityを採用した．
\\
このゲームエンジンを用いることでウェブブラウザ上で動作するキャラクターを簡単に作成することが
でき，ブラウザ上で動作するため，様々なプラットフォームで試すことが可能である．
\\
また，ブラウザを搭載していないデバイスの場合でもUnity自体が複数のプラットフォームに
対応しているため，様々な人が開発したアルゴリズムをすぐに試すことが可能になる．
\\

\subsection{UnityWebPlayerでの出力について}
今回作成した人工知能利用フレームワークではUnityWebPlayerを用いてブラウザ上でキャラクターとの
コミュニケーションを取れるように設計した．\\

\figPst{100}{unity}{Unity Web Playerによるキャラクターの表示画面}

\figref{unity}のようにブラウザを搭載しているPCやmacなどのデバイスならばキャラクターを表示する
ことが可能であり，作成したアルゴリズムをすぐに試すことが可能である．
\\
\subsection{Unityとの連携に利用するWebSocket}
Unityとの通信にはWeb Socketを用いる．
\\
web socketとはウェブサーバーとウェブブラウザとの間の通信のために規定を予定している双方向通信用
の技術規格であり，それを採用した理由としてあげられるのが任意のタイミングでのpush通知が可能な点である．
\\
push通知が可能になることによって，人工知能利用フレームワークから好きなタイミングで命令を送信し，
Unity上のキャラクターを動作させることができるようになるだけではなく，Unity側のプログラムとしても
命令がきた時にだけキャラクターを動作させ，ユーザーから入力があった時だけサーバへ入力情報を送信
すればよいので処理が軽減されるという利点もある．\\

\subsection{Unityへの送信フォーマットと作成}
\figref{output}の「返答内容をJSON形式にまとめてpush送信する」という部分の解説を行う．\\
このUnityへの送信は汎用性の高いJSON形式\footnote{JSON形式：軽量なデータ記述言語の1つ}を用い
て送信を行う．\\

このJSON形式のデータを実際に作成しているのは\figref{output}の出力知能作成ハブであり，
各それぞれの返答内容作成知能ハブや動作選択知能ハブから受け取った情報をまとめてJSON形式
にし，送信を行っている．\\


\subsection{Unityからの受信フォーマット}
Unityから情報を受け取る際にもJSON形式を用いており，現在はユーザーが発言した内容を取得している．\\
JSON形式のデータを解釈する機能も付いているので，Unity側から受け取ることができる情報を随時追加する
ことができる設計となっている．\\


%------------------------------------------------------%
\newpage
%------------------------------------------------------%

\section{アルゴリズムを選定する際に用いるGoogleAPI}
上記で説明したアルゴリズムを選定する際に用いているGoogleAPIについて解説する．\\

\subsection{GoogleAPIについて}
この論文内で示すGooogleAPIとは独自に開発したGoogle検索を用いたプログラムであり，
HttpClientを用いてウェブ上からGoogleの検索結果を取得し，その結果をHttpCleanerで整形し，\\
その後整形した情報を形態素解析にかけて，固有名詞のみを抽出し，固有名詞の単語表を作成するものである．\\
\\

\subsection{GoogleAPIの有効性}
Googleの検索結果を用いることで，常に最新の検索ワードに関するキーワードが手に入る．
\\
そのほかにも一見「料理」という単語と「ごはん」という単語には関連性がないように見える単語も，
この2つの検索結果の単語表には料理という単語が含まれており
，単語表を比較することで同じ分野の単語であることを知ることができる．\\
\\
また，google検索を用いているので，例えば「サバの味噌煮」と検索をして，検索結果の文字列から頻出単語表
を作成した際に，一見料理に全く関係のない単語である文字列である「パッド」という単語が入っている
ことがある，しかし料理関連の解析知能と単語表を比較した時に料理の検索結果とサバの味噌煮の検索結果で
同じサイトである，「クックパッド\footnote{献立に困った時，すぐに希望の食材で検索ができる，
また自分の料理ホームページが簡単にもてる，アクセス数・登録レシピ数ともに日本一のレシピサイトです．}」
が表示されることが多く非常に有効性が高いと推測できるため用いることにした．\\
